
/*======================================================================================*/
/*                                  Package Definition                                  */
/*======================================================================================*/

package org.keylimebox.simplemq.integration.services;

/*======================================================================================*/
/*                                       Imports                                        */
/*======================================================================================*/

import java.util.Date;

import org.apache.commons.lang3.time.DateUtils;
import org.keylimebox.simplemq.integration.model.QueueStatus;
import org.ocpsoft.prettytime.PrettyTime;
import org.springframework.stereotype.Service;

/*======================================================================================*/
/*                           Class Definition / Implementation                          */
/*======================================================================================*/
/*======================================================================================*/
/* CLASS:       MonitoringFormatService                                                 */
/**
 * Converts status reports into format compatible with various monitoring systems.
 * <p>
 * @author      etlweather
 * @since       Jan 3, 2015
 */
/*======================================================================================*/
@SuppressWarnings ("nls")
@Service
public class MonitoringService
{

    /*==================================================================================*/
    /*===================================            ===================================*/
    /*=================================== Attributes ===================================*/
    /*===================================            ===================================*/
    /*==================================================================================*/

    /*==================================================================================*/
    /* Protected Attributes                                                             */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Private Attributes                                                               */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Class Attributes                                                                 */
    /*==================================================================================*/
        /*==============================================================================*/
        /* Constants                                                                    */
        /*==============================================================================*/

        /*==============================================================================*/
        /* Variables                                                                    */
        /*==============================================================================*/

    /*==================================================================================*/
    /*===================================            ===================================*/
    /*=================================== Operations ===================================*/
    /*===================================            ===================================*/
    /*==================================================================================*/

    /*==================================================================================*/
    /* Static initializer                                                               */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Constructors                                                                     */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Attribute Get Operations                                                         */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Attribute Set Operations                                                         */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Private Operations                                                               */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Protected Operations                                                             */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Package Operations                                                               */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Public Operations                                                                */
    /*==================================================================================*/

         /*=============================================================================*/
         /* OPERATION:   toNagios                                                       */
         /**
          * Creates a Nagios compatible status message.
          * <p>
          * @param aQueueStatus
          * @param aWarnMinutes
          * @return
          * <p>
          * @since Jan 3, 2015
          */
         /*=============================================================================*/
   public String toNagios (QueueStatus aQueueStatus, int aWarnMinutes)
   {
      String      myStatus       = "OK";
      Date        myNow          = new Date ();
      Date        myDate         = aQueueStatus.getOldestMessage ();
      PrettyTime  myPrettyTime   = new PrettyTime (myNow);

      if (myDate != null) {
         Date  myThreshold = DateUtils.addMinutes (myNow, aWarnMinutes * -1);
         if (myDate.before (myThreshold)) {
            myStatus       = "WARNING";
         }
      }

      StringBuilder mySb = new StringBuilder ();
      mySb.append ("Status: ");
      mySb.append (myStatus);
      if (myDate != null) {
         mySb.append (" - Oldest message: ");
         mySb.append (myPrettyTime.format (myDate));
      }
      else {
         mySb.append (" - No message in queue");
      }
      mySb.append (" |");
      mySb.append ("nbr=");
      mySb.append (aQueueStatus.getNbrMessage ());

      return mySb.toString ();
   }


    /*==================================================================================*/
    /* Abstract Operations (definitions)                                                */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Abstract Operations (implementations)                                            */
    /*==================================================================================*/

    /*==================================================================================*/
    /* Class (static) Operations                                                        */
    /*==================================================================================*/
}

// EOF  MonitoringFormatService.java
